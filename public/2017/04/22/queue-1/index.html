<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="John Lui"><link rel="alternative" href="/atom.xml" title="Laravel 进阶" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>“队列”第一回——管中窥豹 - Laravel 进阶</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create', 'UA-99090733-1', 'auto');ga('send', 'pageview');
</script><script async src="https://www.google-analytics.com/analytics.js"></script><!-- Hotjar Tracking Code for ochukai.me --></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">Laravel 进阶</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/archives" class="head-nav__link">目录</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head">  <time datetime="2017-04-22T09:29:21.000Z" class="post__time">四月 22, 2017</time><h1 class="post__title">“队列”第一回——管中窥豹</h1><div class="post__main echo"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Redis 是 web 系统的好朋友：超高性能的缓存服务器；而我也非常幸运，在 2014 年夏天第一次需要用到队列的时候，Laravel 4.2 刚刚实现了对 Redis 作为队列系统数据存储后端的支持。</p>
<p>Laravel 采用 Redis 的 list 类型进行队列数据的存储，list 有点像 PHP 中的 Array，拥有许许多多的 API，不再是简单的栈、链表等基础数据结构。Laravel 采用 PHP 命令行（cli）来执行队列中的任务，他们之间的关系如下图所示：</p>
<p><img src="/images/queue-1-1.jpg" alt="架构图"></p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>以下是 Laravel 中采用 Redis 作为数据存储容器的队列使用方法介绍。</p>
<h3 id="1-使用-artisan-创建-job-类"><a href="#1-使用-artisan-创建-job-类" class="headerlink" title="1. 使用 artisan 创建 job 类"></a>1. 使用 artisan 创建 job 类</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan make:job JustTasteQueue</div></pre></td></tr></table></figure>
<p>得到 <code>app/Jobs/JustTasteQueue.php</code> 文件：</p>
<p><img src="/images/queue-1-2.jpg" alt="app/Jobs/JustTasteQueue.php"></p>
<h3 id="2-编写业务逻辑"><a href="#2-编写业务逻辑" class="headerlink" title="2. 编写业务逻辑"></a>2. 编写业务逻辑</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">... ...</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JustTasteQueue</span> <span class="keyword">extends</span> <span class="title">Job</span> <span class="keyword">implements</span> <span class="title">ShouldQueue</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">use</span> <span class="title">InteractsWithQueue</span>, <span class="title">SerializesModels</span>;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> $sleepTime;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($sleepTime)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;sleepTime = $sleepTime;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        sleep(<span class="keyword">$this</span>-&gt;sleepTime);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码中，我们定义了一个类成员变量 <code>$sleepTime</code>，然后在构造函数里面对其进行了赋值，之后在 <code>handle()</code> 函数里调用了这个值，完成了业务处理。</p>
<h3 id="3-入队列"><a href="#3-入队列" class="headerlink" title="3. 入队列"></a>3. 入队列</h3><p>在每个 Laravel 请求的任意生命周期时刻，调用如下代码即会立刻向 Redis 中写入一条任务数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dispatch(<span class="keyword">new</span> \App\Jobs\JustTasteQueue(<span class="number">5</span>));</div></pre></td></tr></table></figure>
<p>Redis 中的数据如下：</p>
<p><img src="/images/queue-1-3.jpg" alt="redis"></p>
<p>Laravel 创建了一个 key 为 queues:default 的 list，并且向其中插入了一条数据，是一段 JSON 字符串，里面详细描述了这个任务，不再赘述。</p>
<h3 id="4-出队列"><a href="#4-出队列" class="headerlink" title="4. 出队列"></a>4. 出队列</h3><p>生产环境中建议采用 <code>php artisan queue:work --daemon</code> 命令进行队列监听：每隔一秒，这个进程会检索一次 Redis，看是否有新的任务，有的话，回取出信息并完成任务。</p>
<hr>

<blockquote>
<h3 id="关于其他的出队列监听命令及-Supervisor-的故事，且听下回分解。"><a href="#关于其他的出队列监听命令及-Supervisor-的故事，且听下回分解。" class="headerlink" title="关于其他的出队列监听命令及 Supervisor 的故事，且听下回分解。"></a>关于其他的出队列监听命令及 Supervisor 的故事，且听下回分解。</h3></blockquote>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/队列/" class="post__tag__link">队列</a></li></ul></footer><link rel="stylesheet" href="//lvwenhan.com:8000/css/static.css"><div id="comments"></div></article></main><footer class="foot"><div class="foot-copy u-fl"><span>©2017 </span><a href="https://github.com/johnlui">John Lui</a></div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><a title="Next" href="/2017/05/13/queue-2/" class="page-menu__link icon-arrow-right"></a></li></menu></footer><script src="//lvwenhan.com:8000/js/static.js"></script><script>LaraDuoshuo.APP_KEY = 'base64:TcZETfYSrvcWGK7J+OuPqPWW4eYxaQinaC9p4JwcDvQ=';LaraDuoshuo.BaseURL = 'https://lvwenhan.com:8000';
</script><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>